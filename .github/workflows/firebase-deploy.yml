name: Deploy to Firebase Hosting

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json
        
    - name: Install Dependencies
      run: |
        echo "ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª..."
        cd functions
        npm ci
        
    - name: Build Project
      run: |
        echo "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹..."
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Ù…Ù„Ù index.html Ù…ÙÙ‚ÙˆØ¯"
          exit 1
        fi
        
        if [ ! -f "public/app.js" ]; then
          echo "âš ï¸ Ù…Ù„Ù app.js Ù…ÙÙ‚ÙˆØ¯ØŒ Ù†Ø³Ø® Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù†..."
          cp public/app-enhanced.js public/app.js
        fi
        
        if [ ! -f "functions/index.js" ]; then
          echo "âš ï¸ Ù…Ù„Ù functions/index.js Ù…ÙÙ‚ÙˆØ¯ØŒ Ù†Ø³Ø® Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù†..."
          cp functions/index-enhanced.js functions/index.js
        fi
        
        echo "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª"
        
    - name: Validate Firebase Configuration
      run: |
        echo "ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒÙˆÙŠÙ† Firebase..."
        
        if [ ! -f "firebase.json" ]; then
          echo "âŒ Ù…Ù„Ù firebase.json Ù…ÙÙ‚ÙˆØ¯"
          exit 1
        fi
        
        if [ ! -f ".firebaserc" ]; then
          echo "âŒ Ù…Ù„Ù .firebaserc Ù…ÙÙ‚ÙˆØ¯"
          exit 1
        fi
        
        echo "âœ… ØªÙƒÙˆÙŠÙ† Firebase ØµØ­ÙŠØ­"
        
    - name: Deploy to Firebase
      run: |
        echo "ğŸš€ Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ Firebase..."
        
        # ØªØ«Ø¨ÙŠØª Firebase CLI
        npm install -g firebase-tools
        
        # Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (ÙŠØªØ·Ù„Ø¨ Firebase Token ÙÙŠ GitHub Secrets)
        # firebase deploy --token "$FIREBASE_TOKEN" --non-interactive
        
        echo "âš ï¸ Ø§Ù„Ù†Ø´Ø± ÙŠØªØ·Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ FIREBASE_TOKEN ÙÙŠ GitHub Secrets"
        echo "ğŸ“ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:"
        echo "1. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Firebase Token: firebase login:ci"
        echo "2. Ø£Ø¶Ù Token Ø¥Ù„Ù‰ GitHub Secrets Ø¨Ø§Ø³Ù… FIREBASE_TOKEN"
        echo "3. Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù† Ø³Ø·Ø± firebase deploy Ø£Ø¹Ù„Ø§Ù‡"
        
    - name: Test Deployment
      run: |
        echo "ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø´Ø±..."
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹
        response=$(curl -s -w "%{http_code}" \
          -H "User-Agent: GitHub-Actions-Test/1.0" \
          --max-time 30 \
          "https://food-recalls-qatar.web.app" || echo "000")
        
        http_code="${response: -3}"
        
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØªØ§Ø­ ÙˆÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ"
        else
          echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ - HTTP $http_code"
        fi
        
    - name: Notify Success
      if: success()
      run: |
        echo "ğŸ‰ ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://food-recalls-qatar.web.app"
        echo "âš¡ Functions: https://us-central1-food-recalls-qatar.cloudfunctions.net"
        echo "ğŸ“± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…"
        
    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø´Ø±"
        echo "ğŸ” ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¨Ø¨"
        echo "ğŸ“ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒÙˆÙŠÙ† Firebase ÙˆGitHub Secrets"

env:
  TZ: Asia/Qatar
  NODE_ENV: production
