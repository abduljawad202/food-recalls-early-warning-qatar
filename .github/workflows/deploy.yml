name: Deploy to Firebase

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # للنشر اليدوي

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Install Functions dependencies
      run: |
        cd functions
        npm ci
        
    - name: Build project
      run: |
        echo "🏗️ بناء المشروع..."
        echo "✅ الواجهة الأمامية جاهزة"
        echo "✅ Cloud Functions جاهزة"
        
    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "🚀 نشر المشروع إلى Firebase..."
        
        # نشر Hosting و Functions
        firebase deploy --token "$FIREBASE_TOKEN" --project food-recalls-qatar
        
        echo "✅ تم النشر بنجاح!"
        echo "🔗 رابط المشروع: https://food-recalls-qatar.web.app"
        
    - name: Post-deployment verification
      run: |
        echo "🔍 التحقق من النشر..."
        
        # انتظار قصير للتأكد من تحديث الخدمات
        sleep 30
        
        # فحص الواجهة الأمامية
        frontend_status=$(curl -s -o /dev/null -w "%{http_code}" "https://food-recalls-qatar.web.app" || echo "000")
        echo "🌐 حالة الواجهة الأمامية: $frontend_status"
        
        # فحص Cloud Functions
        api_status=$(curl -s -o /dev/null -w "%{http_code}" "https://us-central1-food-recalls-qatar.cloudfunctions.net/recalls" || echo "000")
        echo "🔌 حالة Cloud Functions: $api_status"
        
        if [ "$frontend_status" = "200" ] && [ "$api_status" = "200" ]; then
          echo "✅ النشر مكتمل وجميع الخدمات تعمل"
        else
          echo "⚠️ تحذير: قد تحتاج بعض الخدمات وقت إضافي للتحديث"
        fi
        
    - name: Trigger initial data update
      run: |
        echo "🔄 تشغيل تحديث أولي للبيانات..."
        
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Deploy/1.0" \
          "https://us-central1-food-recalls-qatar.cloudfunctions.net/recalls")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        if [ "$http_code" -eq 200 ]; then
          echo "✅ تم تحديث البيانات بنجاح بعد النشر"
          echo "📊 $response_body"
        else
          echo "⚠️ لم يتم تحديث البيانات - سيتم التحديث في الجدولة التالية"
        fi
