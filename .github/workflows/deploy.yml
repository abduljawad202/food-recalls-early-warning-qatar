name: Deploy to Firebase

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Ù„Ù„Ù†Ø´Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Install Functions dependencies
      run: |
        cd functions
        npm ci
        
    - name: Build project
      run: |
        echo "ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹..."
        echo "âœ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©"
        echo "âœ… Cloud Functions Ø¬Ø§Ù‡Ø²Ø©"
        
    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "ğŸš€ Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ Firebase..."
        
        # Ù†Ø´Ø± Hosting Ùˆ Functions
        firebase deploy --token "$FIREBASE_TOKEN" --project food-recalls-qatar
        
        echo "âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: https://food-recalls-qatar.web.app"
        
    - name: Post-deployment verification
      run: |
        echo "ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø´Ø±..."
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¯Ù…Ø§Øª
        sleep 30
        
        # ÙØ­Øµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
        frontend_status=$(curl -s -o /dev/null -w "%{http_code}" "https://food-recalls-qatar.web.app" || echo "000")
        echo "ğŸŒ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©: $frontend_status"
        
        # ÙØ­Øµ Cloud Functions
        api_status=$(curl -s -o /dev/null -w "%{http_code}" "https://us-central1-food-recalls-qatar.cloudfunctions.net/recalls" || echo "000")
        echo "ğŸ”Œ Ø­Ø§Ù„Ø© Cloud Functions: $api_status"
        
        if [ "$frontend_status" = "200" ] && [ "$api_status" = "200" ]; then
          echo "âœ… Ø§Ù„Ù†Ø´Ø± Ù…ÙƒØªÙ…Ù„ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ¹Ù…Ù„"
        else
          echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¨Ø¹Ø¶ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆÙ‚Øª Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ­Ø¯ÙŠØ«"
        fi
        
    - name: Trigger initial data update
      run: |
        echo "ğŸ”„ ØªØ´ØºÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."
        
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Deploy/1.0" \
          "https://us-central1-food-recalls-qatar.cloudfunctions.net/recalls")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±"
          echo "ğŸ“Š $response_body"
        else
          echo "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©"
        fi
