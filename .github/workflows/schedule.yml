name: Scheduled Food Recalls Update

on:
  schedule:
    # ุชุดุบูู ูู 10 ุฏูุงุฆู
    - cron: '*/10 * * * *'
  workflow_dispatch: # ููุชุดุบูู ุงููุฏูู

jobs:
  update-recalls:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Update Food Recalls Data
      run: |
        echo "๐ ุจุฏุก ุงูุชุญุฏูุซ ุงููุฌุฏูู ููุงุณุชุฏุนุงุกุงุช ุงูุบุฐุงุฆูุฉ..."
        echo "โฐ ุงูููุช: $(date)"
        
        # ุงุณุชุฏุนุงุก Cloud Function ููุชุญุฏูุซ
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Scheduler/1.0" \
          "https://us-central1-food-recalls-qatar.cloudfunctions.net/scheduledUpdate")
        
        # ูุตู ุงูุงุณุชุฌุงุจุฉ ุนู ููุฏ ุงูุญุงูุฉ
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "๐ ููุฏ ุงูุงุณุชุฌุงุจุฉ: $http_code"
        echo "๐ ุงูุงุณุชุฌุงุจุฉ: $response_body"
        
        # ุงูุชุญูู ูู ูุฌุงุญ ุงูุนูููุฉ
        if [ "$http_code" -eq 200 ]; then
          echo "โ ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ!"
          
          # ุงุณุชุฎุฑุงุฌ ุนุฏุฏ ุงูุงุณุชุฏุนุงุกุงุช ุงูุฌุฏูุฏุฉ
          new_recalls=$(echo "$response_body" | grep -o '"saved":[0-9]*' | cut -d':' -f2 || echo "0")
          echo "๐ ุนุฏุฏ ุงูุงุณุชุฏุนุงุกุงุช ุงูุฌุฏูุฏุฉ: $new_recalls"
          
          if [ "$new_recalls" -gt 0 ]; then
            echo "๐จ ุชู ุงูุชุดุงู ุงุณุชุฏุนุงุกุงุช ุฌุฏูุฏุฉ!"
          else
            echo "โน๏ธ ูุง ุชูุฌุฏ ุงุณุชุฏุนุงุกุงุช ุฌุฏูุฏุฉ"
          fi
        else
          echo "โ ูุดู ูู ุงูุชุญุฏูุซ - ููุฏ ุงูุฎุทุฃ: $http_code"
          echo "๐ ุชูุงุตูู ุงูุฎุทุฃ: $response_body"
          exit 1
        fi
        
    - name: Log Update Statistics
      if: always()
      run: |
        echo "๐ ุฅุญุตุงุฆูุงุช ุงูุชุญุฏูุซ:"
        echo "๐ ููุช ุงูุงูุชูุงุก: $(date)"
        echo "๐ ุฑุงุจุท ุงููุดุฑูุน: https://food-recalls-qatar.web.app"
        echo "๐ ุฑุงุจุท API: https://us-central1-food-recalls-qatar.cloudfunctions.net/recalls"
        
    - name: Health Check
      run: |
        echo "๐ฅ ูุญุต ุตุญุฉ ุงููุธุงู..."
        
        # ูุญุต ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
        frontend_status=$(curl -s -o /dev/null -w "%{http_code}" "https://food-recalls-qatar.web.app" || echo "000")
        echo "๐ ุญุงูุฉ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ: $frontend_status"
        
        # ูุญุต API
        api_status=$(curl -s -o /dev/null -w "%{http_code}" "https://us-central1-food-recalls-qatar.cloudfunctions.net/recalls" || echo "000")
        echo "๐ ุญุงูุฉ API: $api_status"
        
        if [ "$frontend_status" = "200" ] && [ "$api_status" = "200" ]; then
          echo "โ ุฌููุน ุงูุฎุฏูุงุช ุชุนูู ุจุดูู ุทุจูุนู"
        else
          echo "โ๏ธ ุชุญุฐูุฑ: ุจุนุถ ุงูุฎุฏูุงุช ูุฏ ูุง ุชุนูู ุจุดูู ุตุญูุญ"
        fi
