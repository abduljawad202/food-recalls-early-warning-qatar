name: Scheduled Food Recalls Update

on:
  schedule:
    # تشغيل كل 10 دقائق (مجاني ضمن حدود GitHub Actions)
    - cron: '*/10 * * * *'
  workflow_dispatch:
    # إمكانية التشغيل اليدوي

jobs:
  update-recalls:
    runs-on: ubuntu-latest
    
    steps:
    - name: Trigger Firebase Function Update
      run: |
        echo "🔄 بدء التحديث المجدول للاستدعاءات الغذائية..."
        
        # استدعاء Firebase Function للتحديث
        response=$(curl -s -w "%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Scheduler/1.0" \
          --max-time 300 \
          "https://us-central1-food-recalls-qatar.cloudfunctions.net/scheduledUpdate")
        
        http_code="${response: -3}"
        response_body="${response%???}"
        
        echo "📡 HTTP Status: $http_code"
        echo "📄 Response: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "✅ تم التحديث بنجاح!"
        else
          echo "❌ فشل في التحديث - HTTP $http_code"
          exit 1
        fi
        
    - name: Log Update Status
      run: |
        echo "⏰ وقت التحديث: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "🌐 مصادر البيانات: FDA, CFIA/Health Canada, SFDA, FSANZ"
        echo "🎯 الهدف: مراقبة مستمرة للسلامة الغذائية العالمية"
        echo "🇶🇦 التركيز: حماية المستهلكين في دولة قطر"
        
    - name: Health Check
      run: |
        echo "🏥 فحص صحة النظام..."
        
        # فحص توفر Firebase Functions
        health_response=$(curl -s -w "%{http_code}" \
          -H "User-Agent: GitHub-Actions-HealthCheck/1.0" \
          --max-time 30 \
          "https://us-central1-food-recalls-qatar.cloudfunctions.net/recalls")
        
        health_code="${health_response: -3}"
        
        if [ "$health_code" -eq 200 ]; then
          echo "✅ النظام يعمل بشكل طبيعي"
        else
          echo "⚠️ تحذير: مشكلة في الاتصال بالنظام - HTTP $health_code"
        fi
        
        echo "📊 تم إكمال فحص الصحة"

env:
  TZ: Asia/Qatar
